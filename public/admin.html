<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - Site Marketplace</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .admin-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .admin-stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }
        .admin-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }
        .admin-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .admin-content {
            min-height: 400px;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .admin-table th,
        .admin-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .admin-table th {
            background: var(--light-color);
            font-weight: 600;
        }
        .form-inline {
            display: flex;
            gap: 1rem;
            align-items: end;
            margin-bottom: 2rem;
        }
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            transition: var(--transition);
        }
        .upload-area:hover {
            border-color: var(--primary-color);
        }
        .login-form {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="admin-login" class="admin-login-section">
        <div class="login-form">
            <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <form id="admin-login-form">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω:</label>
                    <input type="text" name="username" required class="form-input">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" name="password" required class="form-input">
                </div>
                <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
            </form>
            <div id="admin-message" class="auth-message"></div>
        </div>
    </div>

    <div id="admin-dashboard" class="admin-dashboard hidden">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Site Marketplace</h1>
                <button id="admin-logout" class="btn btn-secondary">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="admin-stats" id="admin-stats"></div>

        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="dashboard">–î–∞—à–±–æ—Ä–¥</button>
            <button class="admin-tab" data-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="admin-tab" data-tab="sites">–°–∞–π—Ç—ã</button>
            <button class="admin-tab" data-tab="orders">–ó–∞–∫–∞–∑—ã</button>
            <button class="admin-tab" data-tab="invites">–ò–Ω–≤–∞–π—Ç-–∫–æ–¥—ã</button>
            <button class="admin-tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
        </div>

        <div class="admin-content">
            <div id="tab-dashboard" class="tab-pane active">
                <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                <div id="recent-activity"></div>
            </div>

            <div id="tab-users" class="tab-pane hidden">
                <div class="form-inline">
                    <select id="users-status" class="form-select">
                        <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                        <option value="expired">–° –∏—Å—Ç–µ–∫—à–∏–º –¥–æ—Å—Ç—É–ø–æ–º</option>
                    </select>
                    <button id="load-users" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
                <div id="users-table"></div>
            </div>

            <div id="tab-sites" class="tab-pane hidden">
                <div class="form-inline">
                    <select id="sites-category" class="form-select">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    </select>
                    <select id="sites-status" class="form-select">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="available">–î–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                        <option value="sold">–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ</option>
                        <option value="reserved">–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                        <option value="hidden">–°–∫—Ä—ã—Ç—ã–µ</option>
                    </select>
                    <button id="load-sites" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
                <div id="sites-table"></div>
            </div>

            <div id="tab-orders" class="tab-pane hidden">
                <div class="form-inline">
                    <select id="orders-status" class="form-select">
                        <option value="">–í—Å–µ –∑–∞–∫–∞–∑—ã</option>
                        <option value="pending">–û–∂–∏–¥–∞—é—Ç</option>
                        <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ</option>
                        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</option>
                    </select>
                    <button id="load-orders" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
                <div id="orders-table"></div>
            </div>

            <div id="tab-invites" class="tab-pane hidden">
                <div class="form-inline">
                    <input type="text" id="invite-code" placeholder="–ö–æ–¥" class="form-input">
                    <input type="number" id="invite-days" placeholder="–î–Ω–µ–π" value="15" class="form-input">
                    <input type="number" id="invite-uses" placeholder="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π" value="1" class="form-input">
                    <button id="create-invite" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
                <div id="invites-table"></div>
            </div>

            <div id="tab-import" class="tab-pane hidden">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4>–ò–º–ø–æ—Ä—Ç —Å–∞–π—Ç–æ–≤</h4>
                        <select id="import-category" class="form-select">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                        <div class="upload-area" id="sites-upload-area">
                            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ TXT —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏</p>
                            <input type="file" id="sites-file" accept=".txt" style="display: none;">
                            <button onclick="document.getElementById('sites-file').click()" class="btn btn-primary">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                        </div>
                        <label>
                            <input type="checkbox" id="auto-approve"> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä—è—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ –∞–Ω—Ç–∏–ø–∞–±–ª–∏–∫
                        </label>
                        <button id="upload-sites" class="btn btn-success">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∞–π—Ç—ã</button>
                    </div>
                    
                    <div>
                        <h4>–ò–º–ø–æ—Ä—Ç –∞–Ω—Ç–∏–ø–∞–±–ª–∏–∫ –±–∞–∑—ã</h4>
                        <div class="upload-area" id="antipublic-upload-area">
                            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ TXT —Ñ–∞–π–ª —Å –∞–Ω—Ç–∏–ø–∞–±–ª–∏–∫ –±–∞–∑–æ–π</p>
                            <input type="file" id="antipublic-file" accept=".txt" style="display: none;">
                            <button onclick="document.getElementById('antipublic-file').click()" class="btn btn-primary">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                        </div>
                        <button id="upload-antipublic" class="btn btn-warning">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω—Ç–∏–ø–∞–±–ª–∏–∫</button>
                    </div>
                </div>
                
                <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤</h4>
                <div id="import-history"></div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        class AdminPanel {
            constructor() {
                this.currentTab = 'dashboard';
                this.isLoggedIn = false;
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkAuth();
            }

            bindEvents() {
                document.getElementById('admin-login-form').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('admin-logout').addEventListener('click', () => this.logout());
                
                document.querySelectorAll('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.showTab(e.target.dataset.tab));
                });

                document.getElementById('load-users').addEventListener('click', () => this.loadUsers());
                document.getElementById('load-sites').addEventListener('click', () => this.loadSites());
                document.getElementById('load-orders').addEventListener('click', () => this.loadOrders());
                document.getElementById('create-invite').addEventListener('click', () => this.createInvite());
                document.getElementById('upload-sites').addEventListener('click', () => this.uploadSites());
                document.getElementById('upload-antipublic').addEventListener('click', () => this.uploadAntipublic());
            }

            async checkAuth() {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    api.setToken(token);
                    try {
                        const response = await api.get('/admin/dashboard');
                        this.showDashboard(response);
                    } catch (error) {
                        this.showLogin();
                    }
                } else {
                    this.showLogin();
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                try {
                    const response = await api.adminLogin(formData.get('username'), formData.get('password'));
                    localStorage.setItem('admin_token', response.token);
                    api.setToken(response.token);
                    
                    const dashboardData = await api.get('/admin/dashboard');
                    this.showDashboard(dashboardData);
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            }

            showLogin() {
                document.getElementById('admin-login').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }

            showDashboard(data) {
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                this.renderStats(data.stats);
                this.renderRecentActivity(data.recent_activity);
            }

            renderStats(stats) {
                const statsHtml = `
                    <div class="admin-stat-card">
                        <div class="stat-number">${stats.total_users}</div>
                        <div>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-number">${stats.active_users}</div>
                        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-number">${stats.available_sites}</div>
                        <div>–î–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∞–π—Ç–æ–≤</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-number">${stats.sold_sites}</div>
                        <div>–ü—Ä–æ–¥–∞–Ω–æ</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-number">${stats.confirmed_orders}</div>
                        <div>–ó–∞–∫–∞–∑–æ–≤</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-number">${Math.round(stats.total_revenue)}</div>
                        <div>–í—ã—Ä—É—á–∫–∞ ‚ÇΩ</div>
                    </div>
                `;
                document.getElementById('admin-stats').innerHTML = statsHtml;
            }

            showTab(tabName) {
                document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                
                this.currentTab = tabName;
            }

            async loadUsers() {
                const status = document.getElementById('users-status').value;
                try {
                    const response = await api.get('/admin/users', { status });
                    this.renderUsersTable(response.users);
                } catch (error) {
                    UI.showError(error.message);
                }
            }

            renderUsersTable(users) {
                const tableHtml = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>–ó–∞–∫–∞–∑–æ–≤</th>
                                <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.username}</td>
                                    <td>${user.orders_count}</td>
                                    <td>${user.total_spent}‚ÇΩ</td>
                                    <td>${user.is_blocked ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}</td>
                                    <td>
                                        ${!user.is_blocked ? 
                                            `<button onclick="adminPanel.blockUser(${user.id})" class="btn btn-danger btn-sm">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>` :
                                            `<button onclick="adminPanel.unblockUser(${user.id})" class="btn btn-success btn-sm">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('users-table').innerHTML = tableHtml;
            }

            async blockUser(userId) {
                const hours = prompt('–ù–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?', '4');
                const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', '');
                
                if (hours && reason) {
                    try {
                        await api.put(`/admin/users/${userId}/block`, { hours: parseInt(hours), reason });
                        UI.showSuccess('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                        this.loadUsers();
                    } catch (error) {
                        UI.showError(error.message);
                    }
                }
            }

            async unblockUser(userId) {
                try {
                    await api.put(`/admin/users/${userId}/unblock`);
                    UI.showSuccess('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    this.loadUsers();
                } catch (error) {
                    UI.showError(error.message);
                }
            }

            logout() {
                localStorage.removeItem('admin_token');
                api.setToken(null);
                this.showLogin();
            }

            showMessage(message, type) {
                const messageEl = document.getElementById('admin-message');
                messageEl.textContent = message;
                messageEl.className = `auth-message ${type}`;
            }
        }

        const adminPanel = new AdminPanel();
    </script>
</body>
</html>